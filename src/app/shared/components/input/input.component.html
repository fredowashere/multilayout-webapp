<ng-container *ngIf="floatingLabel; else fixedLabel">

    <div *ngIf="type === 'text'" class="form-floating">

        <ng-container *ngIf="mask; else withoutMask">
            <input
                [class.pseudo-disabled]="disabled"
                [tabindex]="disabled ? -1 : 0"
                [class.is-invalid]="isInvalid()"
                [textMask]="{ mask }"
                [formControl]="ngControl"
                type="text"
                class="form-control"
                [class.form-control-sm]="size === 'sm'"
                [class.form-control-lg]="size === 'lg'"
                [id]="_name"
                [placeholder]="placeholder"
                [maxlength]="maxLength"
            >
        </ng-container>
        <ng-template #withoutMask>
            <input
                [class.pseudo-disabled]="disabled"
                [tabindex]="disabled ? -1 : 0"
                [class.is-invalid]="isInvalid()"
                [formControl]="ngControl"
                type="text"
                class="form-control"
                [class.form-control-sm]="size === 'sm'"
                [class.form-control-lg]="size === 'lg'"
                [id]="_name"
                [placeholder]="placeholder"
                [maxlength]="maxLength"
            >
        </ng-template>
        
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'password'" class="form-floating">
        <input
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            type="password"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [id]="_name"
            [placeholder]="placeholder"
            [maxlength]="maxLength"
        >
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'number'" class="form-floating">
        <input
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            type="number"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [id]="_name"
            [placeholder]="placeholder"
            [min]="min"
            [max]="max"
        >
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'textarea'" class="form-floating">
        <textarea
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [id]="_name"
            [placeholder]="placeholder"
            [maxlength]="maxLength"
            style="height: 100px"
        ></textarea>
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'select'" class="form-floating">
        <select
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            class="form-select"
            [class.form-select-sm]="size === 'sm'"
            [class.form-select-lg]="size === 'lg'"
            [id]="_name"
        >
            <option *ngFor="let opt of options" [value]="opt.value">
                {{ opt.text }}
            </option>
        </select>
        <label [for]="disabled ? 'nowhere' : _name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'date'" class="form-floating">
        <input
            type="date"
            class="form-control"
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [placeholder]="placeholder"
            [id]="_name"
            [name]="name"
            [formControl]="ngControl"
            [min]="min"
            [max]="max"
        />
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>
    
    <div *ngIf="type === 'time'" class="form-floating">
        <input
            type="time"
            class="form-control"
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [placeholder]="placeholder"
            [id]="_name"
            [name]="name"
            [formControl]="ngControl"
        />
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>
    
    <div *ngIf="type === 'datetime'" class="form-floating">
        <input
            type="datetime-local"
            class="form-control"
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [placeholder]="placeholder"
            [id]="_name"
            [name]="name"
            [formControl]="ngControl"
            [min]="min"
            [max]="max"
        />
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'autocomplete'" class="form-floating position-relative">
        <input
            type="text"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            #instance="ngbTypeahead"
            [id]="_name"
            [class.is-invalid]="isInvalid()" 
            [placeholder]="placeholder" 
            [ngbTypeahead]="search"
            [inputFormatter]="formatter"
            [resultFormatter]="formatter"
            [resultTemplate]="template"
            [editable]="false"
            [disabled]="disabled"
            [maxlength]="maxLength"
            [(ngModel)]="autocompleteChoice"
            (focus)="focus$.next($any($event).target.value)"
            (click)="onAutocompleteClick(instance, $event)"
            (change)="markAsTouched()"
            (blur)="markAsTouched()"
            (selectItem)="selectItem($event)"
        />
        <label [for]="_name">{{ label }}</label>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>
</ng-container>

<ng-template #fixedLabel>

    <div *ngIf="type === 'text'">
        <label *ngIf="label" [for]="disabled ? 'nowhere' : _name" class="form-label">{{ label }}</label>

        <ng-container *ngIf="mask; else withoutMask">
            <input
                [class.pseudo-disabled]="disabled"
                [tabindex]="disabled ? -1 : 0"
                [class.is-invalid]="isInvalid()"
                [textMask]="{ mask }"
                [formControl]="ngControl"
                type="text"
                class="form-control"
                [class.form-control-sm]="size === 'sm'"
                [class.form-control-lg]="size === 'lg'"
                [id]="_name"
                [placeholder]="placeholder"
                [maxlength]="maxLength"
            >
        </ng-container>
        <ng-template #withoutMask>
            <input
                [class.pseudo-disabled]="disabled"
                [tabindex]="disabled ? -1 : 0"
                [class.is-invalid]="isInvalid()"
                [formControl]="ngControl"
                type="text"
                class="form-control"
                [class.form-control-sm]="size === 'sm'"
                [class.form-control-lg]="size === 'lg'"
                [id]="_name"
                [placeholder]="placeholder"
                [maxlength]="maxLength"
            >
        </ng-template>

        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'password'">
        <label *ngIf="label" [for]="disabled ? 'nowhere' : _name" class="form-label">{{ label }}</label>
        <input
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            type="password"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [id]="_name"
            [placeholder]="placeholder"
            [maxlength]="maxLength"
        >
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'number'">
        <label *ngIf="label" [for]="disabled ? 'nowhere' : _name" class="form-label">{{ label }}</label>
        <input
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            type="number"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [id]="_name"
            [placeholder]="placeholder"
            [min]="min"
            [max]="max"
        >
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'textarea'">
        <label *ngIf="label" [for]="disabled ? 'nowhere' : _name" class="form-label">{{ label }}</label>
        <textarea
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [id]="_name"
            [placeholder]="placeholder"
            [maxlength]="maxLength"
            rows="3"
        ></textarea>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'select'">
        <label *ngIf="label" [for]="disabled ? 'nowhere' : _name" class="form-label">{{ label }}</label>
        <select
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [formControl]="ngControl"
            class="form-select"
            [class.form-select-sm]="size === 'sm'"
            [class.form-select-lg]="size === 'lg'"
            [id]="_name"
        >
            <option *ngFor="let opt of options" [ngValue]="opt.value">
                {{ opt.text }}
            </option>
        </select>
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'date'" >
        <label *ngIf="label" class="form-label" [for]="disabled ? 'nowhere' : _name">{{ label }}</label>
        <input
            type="date"
            class="form-control"
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [placeholder]="placeholder"
            [id]="_name"
            [name]="name"
            [formControl]="ngControl"
            [min]="min"
            [max]="max"
        />
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>
    
    <div *ngIf="type === 'time'" >
        <label *ngIf="label" class="form-label" [for]="disabled ? 'nowhere' : _name">{{ label }}</label>
        <input
            type="time"
            class="form-control"
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [placeholder]="placeholder"
            [id]="_name"
            [name]="name"
            [formControl]="ngControl"
        />
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>
    
    <div *ngIf="type === 'datetime'" >
        <label *ngIf="label" class="form-label" [for]="disabled ? 'nowhere' : _name">{{ label }}</label>
        <input
            type="datetime-local"
            class="form-control"
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            [class.is-invalid]="isInvalid()"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            [placeholder]="placeholder"
            [id]="_name"
            [name]="name"
            [formControl]="ngControl"
            [min]="min"
            [max]="max"
        />
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>

    <div *ngIf="type === 'autocomplete'" class="position-relative">
        <label *ngIf="label" class="form-label" [for]="_name">{{ label }}</label>
        <input
            type="text"
            class="form-control"
            [class.form-control-sm]="size === 'sm'"
            [class.form-control-lg]="size === 'lg'"
            #instance="ngbTypeahead"
            [id]="_name"
            [class.is-invalid]="isInvalid()"
            [placeholder]="placeholder"
            [ngbTypeahead]="search"
            [inputFormatter]="formatter"
            [resultFormatter]="formatter"
            [resultTemplate]="template"
            [editable]="false"
            [disabled]="disabled"
            [maxlength]="maxLength"
            [(ngModel)]="autocompleteChoice"
            (focus)="focus$.next($any($event).target.value)"
            (click)="onAutocompleteClick(instance, $event)"
            (change)="markAsTouched()"
            (blur)="markAsTouched()"
            (selectItem)="selectItem($event)"
        />
        <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
    </div>
</ng-template>

<div *ngIf="type === 'checkbox'" class="form-check">
    <input
        [class.pseudo-disabled]="disabled"
        [tabindex]="disabled ? -1 : 0"
        [class.is-invalid]="isInvalid()"
        [formControl]="ngControl"
        class="form-check-input"
        type="checkbox"
        [id]="_name"
    >
    <label *ngIf="label" class="form-check-label" [for]="disabled ? 'nowhere' : _name">
      {{ label }}
    </label>
    <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
</div>

<div *ngIf="type === 'radio'">
    <div *ngFor="let opt of options" class="form-check">
        <input
            [class.pseudo-disabled]="disabled"
            [tabindex]="disabled ? -1 : 0"
            class="form-check-input"
            [value]="opt.value"
            type="radio"
            [name]="name"
            [id]="opt._id"
        >
        <label class="form-check-label" [for]="disabled ? 'nowhere' : opt._id">
          {{ opt.text }}
        </label>
    </div>
</div>

<div *ngIf="type === 'tagger'">
    <label class="form-label" *ngIf="label" [for]="_name">{{ label }}</label>
    <div class="d-flex flex-wrap gap-2 mb-2">
        <span
            *ngFor="let tag of tags"
            class="badge d-flex align-items-center fs-6 rounded-pill bg-secondary"
        >
            <div>{{ formatter(tag) }}</div>
            <button class="btn p-0 lh-0 fs-6 text-white" (click)="removeTag(tag)"><i class="bi bi-x"></i></button>
        </span>
    </div>
    <input
        type="text"
        class="form-control"
        [class.form-control-sm]="size === 'sm'"
        [class.form-control-lg]="size === 'lg'"
        #instance="ngbTypeahead"
        [id]="_name"
        [class.is-invalid]="isInvalid()"
        [placeholder]="placeholder"
        [ngbTypeahead]="search"
        [inputFormatter]="formatter"
        [resultFormatter]="formatter"
        [resultTemplate]="template"
        [editable]="false"
        [disabled]="disabled"
        [maxlength]="maxLength"
        [(ngModel)]="autocompleteChoice"
        (focus)="focus$.next($any($event).target.value)"
        (click)="onAutocompleteClick(instance, $event)"
        (change)="markAsTouched()"
        (blur)="markAsTouched()"
        (selectItem)="taggerChoiceSelected($event)"
    />
    <ng-container *ngTemplateOutlet="invalidFeedback; context: { $implicit: ngControl }"></ng-container>
</div>

<div *ngIf="helper" class="form-text ps-2">{{ helper }}</div>

<ng-template #invalidFeedback let-ngControl>
    <div class="invalid-feedback">
        <div *ngIf="ngControl.errors?.min">
            Minimo {{ ngControl.errors?.min.min }}
        </div>
        <div *ngIf="ngControl.errors?.max">
            Massimo {{ ngControl.errors?.max.max }}
        </div>
        <div *ngIf="ngControl.errors?.required">
            Richiesto
        </div>
        <div *ngIf="ngControl.errors?.email">
            Email invalida
        </div>
        <div *ngIf="ngControl.errors?.minlength">
            Lunghezza minima {{ ngControl.errors?.minlength.requiredLength }}
        </div>
        <div *ngIf="ngControl.errors?.maxlength">
            Lunghezza massima {{ ngControl.errors?.maxlength.requiredLength }}
        </div>
        <div *ngIf="ngControl.errors?.pattern">
            Non corrisponde al pattern regolare {{ ngControl.errors?.pattern.requiredPattern }}
        </div>
    </div>
</ng-template>
